{% extends "base.html" %}

{% block title %}My Applications - JobRight.ai Mock{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2>
                        <i class="fas fa-file-alt text-primary"></i> My Applications
                    </h2>
                    <p class="text-muted">Track your job applications and their status</p>
                </div>
                <div>
                    <a href="{{ url_for('jobs_recommend') }}" class="btn btn-primary-custom">
                        <i class="fas fa-search"></i> Find More Jobs
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number">{{ applications|length }}</div>
                <div class="stats-label">Total Applications</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number text-success">{{ applications|selectattr('application_status', 'equalto', 'applied')|list|length }}</div>
                <div class="stats-label">Applied</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number text-warning">{{ applications|selectattr('application_status', 'equalto', 'viewed')|list|length }}</div>
                <div class="stats-label">Viewed</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-number text-info">{{ applications|selectattr('application_status', 'equalto', 'interview')|list|length }}</div>
                <div class="stats-label">Interview</div>
            </div>
        </div>
    </div>

    <!-- Status Filter -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card-custom p-3">
                <div class="d-flex align-items-center">
                    <label class="me-3 fw-bold">Filter by Status:</label>
                    <button class="btn btn-outline-primary btn-sm me-2 filter-btn active" data-status="all">
                        All Applications
                    </button>
                    <button class="btn btn-outline-success btn-sm me-2 filter-btn" data-status="applied">
                        Applied
                    </button>
                    <button class="btn btn-outline-warning btn-sm me-2 filter-btn" data-status="viewed">
                        Viewed
                    </button>
                    <button class="btn btn-outline-info btn-sm me-2 filter-btn" data-status="interview">
                        Interview
                    </button>
                    <button class="btn btn-outline-danger btn-sm filter-btn" data-status="rejected">
                        Rejected
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Applications List -->
    <div class="row">
        <div class="col-12">
            {% if applications %}
                {% for app in applications %}
                <div class="job-card application-card" data-status="{{ app.application_status }}">
                    <div class="row">
                        <div class="col-md-2 text-center mb-3 mb-md-0">
                            <div class="company-logo mx-auto">
                                {{ app.company[0] }}
                            </div>
                            <div class="match-score mt-2">
                                {{ "%.0f"|format(app.match_score) }}% Match
                            </div>
                        </div>

                        <div class="col-md-6">
                            <h5 class="job-title mb-2">
                                <a href="{{ app.application_url }}" target="_blank" class="text-decoration-none">
                                    {{ app.title }}
                                </a>
                            </h5>

                            <div class="company-info mb-2">
                                <strong>{{ app.company }}</strong>
                                <span class="text-muted mx-2">•</span>
                                <i class="fas fa-map-marker-alt text-muted"></i> {{ app.location }}
                                {% if app.remote_friendly %}
                                <span class="badge bg-success ms-2">Remote Friendly</span>
                                {% endif %}
                            </div>

                            <div class="salary-range mb-2">
                                <i class="fas fa-dollar-sign"></i>
                                ${{ "{:,}".format(app.salary_min) }} - ${{ "{:,}".format(app.salary_max) }}
                                <span class="text-muted">• {{ app.job_type.title() }}</span>
                            </div>

                            <div class="job-meta mb-3">
                                <small class="text-muted">
                                    <i class="fas fa-clock"></i>
                                    Applied {{ app.applied_at.strftime('%B %d, %Y') }}
                                    <span class="mx-2">•</span>
                                    <i class="fas fa-layer-group"></i>
                                    {{ app.experience_level.title() }} Level
                                </small>
                            </div>

                            <div class="skills mb-3">
                                {% for skill in app.skills[:5] %}
                                <span class="skill-tag">{{ skill }}</span>
                                {% endfor %}
                                {% if app.skills|length > 5 %}
                                <span class="skill-tag">+{{ app.skills|length - 5 }} more</span>
                                {% endif %}
                            </div>
                        </div>

                        <div class="col-md-4 text-md-end">
                            <div class="application-status mb-3">
                                <label class="form-label">Application Status</label>
                                <select class="form-select form-select-sm status-select"
                                        data-job-id="{{ app.id }}"
                                        onchange="updateApplicationStatus('{{ app.id }}', this.value)">
                                    <option value="applied" {{ 'selected' if app.application_status == 'applied' }}>Applied</option>
                                    <option value="viewed" {{ 'selected' if app.application_status == 'viewed' }}>Viewed</option>
                                    <option value="interview" {{ 'selected' if app.application_status == 'interview' }}>Interview</option>
                                    <option value="rejected" {{ 'selected' if app.application_status == 'rejected' }}>Rejected</option>
                                    <option value="offer" {{ 'selected' if app.application_status == 'offer' }}>Offer</option>
                                </select>
                            </div>

                            <div class="application-actions mb-3">
                                <button class="btn btn-outline-primary btn-sm w-100 mb-2"
                                        onclick="addNote('{{ app.id }}')">
                                    <i class="fas fa-sticky-note"></i> Add Note
                                </button>

                                <a href="{{ app.application_url }}" target="_blank"
                                   class="btn btn-outline-success btn-sm w-100">
                                    <i class="fas fa-external-link-alt"></i> View Job
                                </a>
                            </div>

                            <div class="job-source">
                                <small class="text-muted">
                                    <i class="fas fa-external-link-alt"></i>
                                    via {{ app.source.title() }}
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Application Notes -->
                    {% if app.notes %}
                    <div class="application-notes mt-3">
                        <hr>
                        <h6><i class="fas fa-sticky-note"></i> Notes</h6>
                        <div class="alert alert-light">
                            {{ app.notes }}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Expandable Job Description -->
                    <div class="job-description mt-3" style="display: none;">
                        <hr>
                        <h6>Job Description</h6>
                        <div style="white-space: pre-line;">{{ app.description }}</div>

                        <h6 class="mt-3">Benefits</h6>
                        <ul>
                            {% for benefit in app.benefits %}
                            <li>{{ benefit }}</li>
                            {% endfor %}
                        </ul>
                    </div>

                    <div class="text-center mt-2">
                        <button class="btn btn-link btn-sm text-muted" onclick="toggleDescription(this)">
                            <i class="fas fa-chevron-down"></i> Show Job Details
                        </button>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <!-- Empty State -->
                <div class="text-center py-5">
                    <i class="fas fa-file-alt fa-3x text-muted mb-4"></i>
                    <h4>No Applications Yet</h4>
                    <p class="text-muted mb-4">
                        Start applying to jobs from our recommendations to track your progress.
                    </p>
                    <a href="{{ url_for('jobs_recommend') }}" class="btn btn-primary-custom">
                        <i class="fas fa-search"></i> Browse Job Recommendations
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Add Note Modal -->
<div class="modal fade" id="noteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Application Note</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <textarea class="form-control" id="noteText" rows="4"
                          placeholder="Add notes about this application, interview details, follow-up actions, etc."></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary-custom" onclick="saveNote()">Save Note</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentJobId = null;

    // Status filter functionality
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            // Update active button
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');

            // Filter applications
            const status = this.dataset.status;
            document.querySelectorAll('.application-card').forEach(card => {
                if (status === 'all' || card.dataset.status === status) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        });
    });

    function toggleDescription(button) {
        const jobCard = button.closest('.job-card');
        const description = jobCard.querySelector('.job-description');
        const icon = button.querySelector('i');

        if (description.style.display === 'none') {
            description.style.display = 'block';
            icon.className = 'fas fa-chevron-up';
            button.innerHTML = '<i class="fas fa-chevron-up"></i> Hide Job Details';
        } else {
            description.style.display = 'none';
            icon.className = 'fas fa-chevron-down';
            button.innerHTML = '<i class="fas fa-chevron-down"></i> Show Job Details';
        }
    }

    function updateApplicationStatus(jobId, status) {
        // Update the visual status
        const card = document.querySelector(`[data-job-id="${jobId}"]`).closest('.application-card');
        card.dataset.status = status;

        // Here you would make an API call to update the status in the database
        fetch(`/api/applications/${jobId}/status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ status: status })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Application status updated', 'success');
            } else {
                showToast('Failed to update status', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Failed to update status', 'error');
        });
    }

    function addNote(jobId) {
        currentJobId = jobId;
        const modal = new bootstrap.Modal(document.getElementById('noteModal'));
        document.getElementById('noteText').value = '';
        modal.show();
    }

    function saveNote() {
        const noteText = document.getElementById('noteText').value.trim();
        if (!noteText) {
            showToast('Please enter a note', 'warning');
            return;
        }

        // Here you would make an API call to save the note
        fetch(`/api/applications/${currentJobId}/note`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ note: noteText })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Note saved successfully', 'success');
                bootstrap.Modal.getInstance(document.getElementById('noteModal')).hide();

                // Add the note to the UI
                const card = document.querySelector(`[data-job-id="${currentJobId}"]`).closest('.application-card');
                let notesSection = card.querySelector('.application-notes');

                if (!notesSection) {
                    const newNotesHTML = `
                        <div class="application-notes mt-3">
                            <hr>
                            <h6><i class="fas fa-sticky-note"></i> Notes</h6>
                            <div class="alert alert-light">${noteText}</div>
                        </div>
                    `;
                    card.querySelector('.job-description').insertAdjacentHTML('beforebegin', newNotesHTML);
                } else {
                    notesSection.querySelector('.alert').textContent = noteText;
                }
            } else {
                showToast('Failed to save note', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Failed to save note', 'error');
        });
    }

    // Add status color coding
    document.querySelectorAll('.status-select').forEach(select => {
        updateStatusColor(select);
        select.addEventListener('change', function() {
            updateStatusColor(this);
        });
    });

    function updateStatusColor(select) {
        select.className = 'form-select form-select-sm status-select';
        switch(select.value) {
            case 'applied':
                select.classList.add('border-success');
                break;
            case 'viewed':
                select.classList.add('border-warning');
                break;
            case 'interview':
                select.classList.add('border-info');
                break;
            case 'rejected':
                select.classList.add('border-danger');
                break;
            case 'offer':
                select.classList.add('border-primary');
                break;
        }
    }
</script>
{% endblock %}